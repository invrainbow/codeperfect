#!/bin/bash
set -e

VERSION="$(grep CurrentVersion gostuff/versions/versions.go | rev | cut -d' ' -f 1 | rev)"

# clear out everything for a fresh build
rm -rf build/bin obj

# build again
RELEASE=1 sh/build_macos

package_app() {
    APPNAME="CodePerfect.app"
    rm -rf "${APPNAME}"
    mkdir -p "${APPNAME}/Contents/MacOS"
    cp -R ../build/bin/ "${APPNAME}/Contents/MacOS/bin/"
    cp ../build/launcher "${APPNAME}/Contents/MacOS/CodePerfect"
    zip -r app.zip CodePerfect.app/
    sha256sum app.zip
    # aws s3 cp app.zip "s3://codeperfect95/app/darwin_v${VERSION}.zip"
}

package_update() {
    zip -j -r update.zip ../build/bin/ 
    sha256sum update.zip
    # aws s3 cp update.zip "s3://codeperfect95/update/darwin_v${VERSION}.zip"
}

rm -rf scratch/
mkdir scratch/
cd scratch

package_app
package_update
