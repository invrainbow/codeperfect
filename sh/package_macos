#!/bin/bash
set -e

# grab version from versions.go
VERSION="$(grep CurrentVersion gostuff/versions/versions.go | rev | cut -d' ' -f 1 | rev)"

# build the actual app
if [[ -z "$NO_REBUILD" ]]; then
    RELEASE=1 sh/build_macos
fi

# create scratch directory
rm -rf scratch/
mkdir scratch/
cd scratch

# create .app from launcher
rm -rf CodePerfect.app
appify -name CodePerfect \
    -icon ../logo.png \
    -version "0.${VERSION}.0" \
    -author "CodePerfect" \
    -id com.codeperfect95 \
    ../build/launcher

# create bin folder inside .app
cp -R ../build/bin/ "CodePerfect.app/Contents/MacOS/bin/"
rm -rf CodePerfect.app/Contents/README
rm -rf CodePerfect.app/Contents/MacOS/bin/ide.d

# zip up app
zip -r app.zip CodePerfect.app/

# zip up update
pushd CodePerfect.app/Contents/MacOS/bin
zip -r ../../../../update.zip *
popd

# push to s3 & database
if [[ -z "$SKIP_UPLOAD" ]]; then
    aws s3 cp app.zip "s3://codeperfect95/app/darwin_v${VERSION}.zip"
    aws s3 cp update.zip "s3://codeperfect95/update/darwin_v${VERSION}.zip"

    cd ../gostuff
    POSTGRES_URL=$POSTGRES_URL_PROD go run ./cmd/addversion "darwin" ../scratch/app.zip ../scratch/update.zip
fi
